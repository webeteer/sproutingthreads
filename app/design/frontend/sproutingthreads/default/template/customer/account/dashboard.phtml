<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     rwd_default
 * @copyright   Copyright (c) 2014 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<div class="dashboard">
    <div class="page-title">
        <h1><?php echo $this->__('My Dashboard') ?></h1>
    </div>
	
	
    <?php echo $this->getMessagesBlock()->getGroupedHtml() ?>
	
	
	<?php
	$customer = Mage::getSingleton('customer/session')->getCustomer();
	
	
	$customerId = $customer->getId();
	
	$profiles = Mage::getModel('sales/recurring_profile')->getCollection()->addFieldToSelecT('*')->addFieldToFilter('customer_id', $customerId);
	
	$numProfiles = count($profiles);
	if ($numProfiles > 0): 
	?>
		<div id="profileShipList">
			<?
			foreach($profiles as $profile) {
				
				$data = $profile->getOrigData();
				
				$order = unserialize($data['order_info']);
				$orderItems = unserialize($data['order_item_info']);
				$buyRequest = unserialize($orderItems['info_buyRequest']);
				$schedule = $profile->exportScheduleInfo();
				
				$productId = $buyRequest['product_id'];
				
				$nameFieldId = getConfigField($productId, "name");
				$name = $buyRequest['options'][$nameFieldId];
				
				$childOrders = $profile->getChildOrderIds();
				$numShipped = count($childOrders);
				$startdate = "";
				
				
				$recentOrder = array_pop($childOrders);
				
				$orderData = Mage::getModel('sales/order')->load($recentOrder)->getOrigData();
				
				$orderDate = $orderData['created_at'];
				
				if ($productId = $productMonthly) {
					$type = "monthly";
				} else {
					$type = "seasonal";
				}
				
				
				$shipDate = getShipDate($type, "current", $orderDate);
				$shipDateDisplay = date("l F jS", strtotime($shipDate));
				?>
					<div class="profileShip">
						<b><?php echo $name; ?>'s</b> next shipment is scheduled for:<br/><b><?php echo $shipDateDisplay; ?></b>
					</div>
				<?
				//echo "Name: $name / $numShipped / $orderDate / $type / $shipDate";
			}
			?>
		</div>
	<? endif; ?>
	</div>	
    <?php echo $this->getChildHtml('hello') ?>

    <!--<?php echo $this->getChildHtml('top') ?>-->
	

	
	<div id="return" class="box-account box-info">
		<h2>Rethreading or Returning?</h2>
		Let us know if you're sending threads back by checking whether it is a return or a reThread. please refer to the reThread guidelines as well as return policies for details.
		<script>
		
			objCustomer = <?php
			$customer = Mage::getSingleton('customer/session')->getCustomer();
			
			echo json_encode($customer->_data);
		?>;
		</script>
		<div class="button-set">
			<a href="#" id="rethread" class="button" data-action="rethread">reThreads coming</a>
			<a href="#" id="return" class="button" data-action="return">returns coming</a>
		</div>
	</div>
    <div class="box-account box-info">
        <div class="box-head">
            <h2><?php echo $this->__('Account Information') ?></h2>
        </div>
        <?php /* Extensions placeholder */ ?>
        <?php echo $this->getChildHtml('customer.account.dashboard.extra') ?>
        <!--<?php echo $this->getChildHtml('info') ?>-->
    </div>
    <?php echo $this->getChildHtml('address') ?>
    <?php echo $this->getChildHtml('info1') ?>
    <?php echo $this->getChildHtml('info2') ?>
	
	<div id="contactFormSection" class="box-account box-info sky-form">
		<h2>Contact Us?</h2>
		<div class="forThank">
			Ask any questions you might have about your threads. If reThreading or returns please note how you would like us to deal with items not accepted? Donate to local charity or return to you (at subscribers expense)
			<textarea name="contactForm" id="contactFormField"></textarea>
			<div class="button-set">
				<a href="#" id="contactFormButton" class="button" data-action="contactForm">Send!</a>
			</div>
		</div>
	</div>	
	
</div>
